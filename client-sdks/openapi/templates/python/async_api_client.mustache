# coding: utf-8

{{>partial_header}}

from __future__ import annotations

import asyncio

from typing import Any
import httpx
from httpx import AsyncClient, Timeout

from {{packageName}}.configuration import Configuration
from {{packageName}}.async_api_response import AsyncApiResponse
from {{packageName}}.async_stream import AsyncStream
from {{packageName}}.exceptions import ApiException


class AsyncApiClient:
    """Async API client for OpenAPI client library builds.

    This client handles asynchronous client-server communication using httpx.

    :param configuration: Configuration object for this client
    :param http_client: Optional httpx.AsyncClient instance
    :param header_name: Optional header to pass when making calls to the API
    :param header_value: Optional header value to pass when making calls to the API
    :param cookie: Optional cookie to include in the header when making calls to the API
    """

    def __init__(
        self,
        configuration: Configuration | None = None,
        http_client: AsyncClient | None = None,
        header_name: str | None = None,
        header_value: str | None = None,
        cookie: str | None = None,
    ) -> None:
        # Use default configuration if none is provided
        if configuration is None:
            configuration = Configuration.get_default()
        self.configuration = configuration

        # Set up default headers
        self.default_headers: dict[str, str] = {}
        if header_name is not None and header_value is not None:
            self.default_headers[header_name] = header_value

        # Set default User-Agent
        self.default_headers['User-Agent'] = '{{{httpUserAgent}}}{{^httpUserAgent}}OpenAPI-Generator/{{{packageVersion}}}/python{{/httpUserAgent}}'

        self.cookie = cookie

        # Create or use provided httpx AsyncClient
        if http_client is not None:
            self._client = http_client
            self._client_provided = True
        else:
            # Build httpx client with configuration
            timeout = Timeout(
                timeout=configuration.timeout if hasattr(configuration, 'timeout') else 60.0
            )

            client_args = {
                'timeout': timeout,
                'headers': self.default_headers,
                'verify': configuration.verify_ssl if hasattr(configuration, 'verify_ssl') else True,
            }

            if hasattr(configuration, 'host') and configuration.host:
                client_args['base_url'] = configuration.host

            if hasattr(configuration, 'ssl_ca_cert') and configuration.ssl_ca_cert:
                client_args['verify'] = configuration.ssl_ca_cert

            if hasattr(configuration, 'cert_file') and configuration.cert_file:
                cert_tuple = (configuration.cert_file,)
                if hasattr(configuration, 'key_file') and configuration.key_file:
                    cert_tuple = (configuration.cert_file, configuration.key_file)
                client_args['cert'] = cert_tuple

            if hasattr(configuration, 'proxy') and configuration.proxy:
                client_args['proxies'] = configuration.proxy

            self._client = AsyncClient(**client_args)
            self._client_provided = False

    async def __aenter__(self):
        """Async context manager entry."""
        return self

    async def __aexit__(self, exc_type, exc_value, traceback):
        """Async context manager exit."""
        await self.close()

    async def close(self):
        """Close the async HTTP client."""
        if not self._client_provided:
            await self._client.aclose()

    @property
    def user_agent(self) -> str:
        """User agent for this API client."""
        return self.default_headers.get('User-Agent', '')

    @user_agent.setter
    def user_agent(self, value: str):
        """Set the user agent."""
        self.default_headers['User-Agent'] = value

    def set_default_header(self, header_name: str, header_value: str):
        """Set a default header."""
        self.default_headers[header_name] = header_value

    async def request(
        self,
        method: str,
        url: str,
        headers: dict[str, str] | None = None,
        params: dict[str, Any] | None = None,
        json: Any | None = None,
        data: Any | None = None,
        files: dict[str, Any] | None = None,
        stream: bool = False,
    ) -> AsyncApiResponse | AsyncStream:
        """
        Make an async HTTP request.

        :param method: HTTP method (GET, POST, etc.)
        :param url: Request URL
        :param headers: Optional headers dict
        :param params: Optional query parameters
        :param json: Optional JSON body
        :param data: Optional form data
        :param files: Optional files to upload
        :param stream: Whether to stream the response
        :return: AsyncApiResponse or AsyncStream object
        """
        # Merge headers
        request_headers = self.default_headers.copy()
        if headers:
            request_headers.update(headers)

        # Add cookie if present
        if self.cookie:
            request_headers['Cookie'] = self.cookie

        try:
            response = await self._client.request(
                method=method,
                url=url,
                headers=request_headers,
                params=params,
                json=json,
                data=data,
                files=files,
            )

            if stream:
                return AsyncStream(response, self)
            else:
                return AsyncApiResponse(response)

        except httpx.HTTPError as e:
            raise ApiException(status=0, reason=str(e))

    _default = None

    @classmethod
    def get_default(cls):
        """Return new instance of AsyncApiClient.

        This method returns a newly created instance based on the default constructor,
        or returns a copy of the default AsyncApiClient.

        :return: The AsyncApiClient object.
        """
        if cls._default is None:
            cls._default = AsyncApiClient()
        return cls._default

    @classmethod
    def set_default(cls, default):
        """Set default instance of AsyncApiClient.

        :param default: object of AsyncApiClient.
        """
        cls._default = default
